<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numberblocks: La Aventura en la MontaÃ±a</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;700&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --nb-1: #e53935; --nb-2: #fb8c00; --nb-3: #fdd835;
            --nb-4: #43a047; --nb-5: #1e88e5;
            --c-fondo: #f0f8ff;
            --c-tierra: #63C132;
            --c-camino: #d2b48c; --c-camino-borde: #8b5a2b;
            --c-texto: #3a3a3a; --c-panel: #ffffff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--c-fondo);
            color: var(--c-texto);
            margin: 0;
            padding: 20px;
        }

        .game-world {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .main-title {
            font-family: 'Fredoka', sans-serif;
            font-size: clamp(2rem, 5vw, 2.5rem);
            margin: 0 0 10px 0;
            color: #2c3e50;
            text-align: center;
        }

        .game-board-container {
            width: 100%;
            height: 55vh;
            max-height: 450px;
            min-height: 300px;
            background: linear-gradient(to bottom, #87ceeb 60%, #3CB371 100%);
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2), inset 0 0 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        #game-board-svg {
            width: 100%;
            height: 100%;
        }

        #game-board-svg .path-line {
            stroke: var(--c-camino-borde);
            stroke-width: 25;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        
        #game-board-svg .path-fill {
            stroke: var(--c-camino);
            stroke-width: 18;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        #game-board-svg .step-circle {
            fill: #fff;
            stroke: var(--c-camino-borde);
            stroke-width: 2;
        }
        
        #game-board-svg .step-special-good { fill: #5dade2; }
        #game-board-svg .step-special-bad { fill: #95a5a6; }
        #game-board-svg .step-text { font-family: 'Fredoka', sans-serif; font-size: 14px; fill: #fff; text-anchor: middle; dominant-baseline: central; }
        
        #player {
            width: 40px;
            height: auto;
            position: absolute;
            transition: all 0.2s ease-in-out;
            z-index: 10;
            filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.3));
            transform: translate(-50%, -100%);
        }

        .ui-panel {
            width: 100%;
            max-width: 700px;
            background: var(--c-panel);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
        }
        
        #character-selection .numberblock {
            display: inline-block;
            margin: 0 10px;
        }
        
        .operation-machine {
            background: #f0f0f0;
            border-radius: 15px;
            padding: 20px;
        }
        
        #story-text {
            font-size: 1.1rem;
            min-height: 40px;
        }

        #operation-display {
            font-family: 'Fredoka', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
            color: #3498db;
        }

        #answer-input {
            width: 150px;
            height: 50px;
            border: 3px solid #ccc;
            border-radius: 10px;
            text-align: center;
            font-size: 2rem;
            font-family: 'Fredoka', sans-serif;
        }

        #submit-button {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            cursor: pointer;
            margin-left: 10px;
            vertical-align: middle;
            box-shadow: 0 4px 0 #1e8449;
            transition: all 0.1s ease;
        }
        #submit-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1e8449;
        }
        
        #message-area {
            font-weight: bold;
            font-size: 1.2rem;
            min-height: 25px;
            margin-top: 10px;
        }
        
        .hidden { display: none; }
        
        /* Numberblock styles */
        .numberblock {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
        }
        .numberblock:hover { transform: translateY(-5px); }
        .numberblock.selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px #f1c40f;
            border-radius: 4px;
        }
        .block {
            width: 25px; height: 25px;
            border: 2px solid rgba(0,0,0,0.15);
            margin-top: -2px;
            position: relative;
            display:flex; justify-content:center; align-items:center;
        }
        .block:first-child { border-radius: 0 0 4px 4px; }
        .block:last-child { border-radius: 4px 4px 0 0; }
        .block:only-child { border-radius: 4px; }
        .face-container { width: 100%; height: 100%; position: relative; display: none; justify-content: center; align-items: center; gap: 4px; }
        .numberblock.has-face .face-container { display: flex; }
        .eye { width: 6px; height: 6px; background-color: #000; border-radius: 50%; position: relative; }
        .eye::after { content: ''; position: absolute; width: 2px; height: 2px; background-color: #fff; border-radius: 50%; top: 1px; left: 1px; }
        .c1 { background-color: var(--nb-1); } .c2 { background-color: var(--nb-2); }
        .c3 { background-color: var(--nb-3); } .c4 { background-color: var(--nb-4); }
        .c5 { background-color: var(--nb-5); }
    </style>
</head>
<body>

    <div class="game-world">
        <h1 class="main-title">La Aventura en la MontaÃ±a de JesÃºs</h1>
        <div class="game-board-container">
            <svg id="game-board-svg" preserveAspectRatio="xMidYMid meet"></svg>
            <div id="player"></div>
        </div>

        <div class="ui-panel">
            <div id="character-selection">
                <p>Elige tu personaje para la carrera:</p>
                <!-- Characters will be generated here -->
            </div>

            <div class="operation-machine hidden" id="operation-machine">
                <p id="story-text">Â¡Resuelve la operaciÃ³n para avanzar!</p>
                <div id="operation-display"></div>
                <div>
                    <input type="number" id="answer-input" inputmode="numeric">
                    <button id="submit-button">Â¡Avanzar!</button>
                </div>
                <div id="message-area"></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const boardContainer = document.querySelector('.game-board-container');
        const svg = document.getElementById('game-board-svg');
        const player = document.getElementById('player');
        const opMachine = document.getElementById('operation-machine');
        const opDisplay = document.getElementById('operation-display');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('submit-button');
        const messageArea = document.getElementById('message-area');
        const storyText = document.getElementById('story-text');
        const charSelection = document.getElementById('character-selection');

        const TOTAL_STEPS = 60;
        let playerPosition = 0;
        let correctAnswer = 0;
        let pathCoordinates = [];
        let path;
        const specialSteps = {
            8: { type: 'good', value: 10, icon: 'ðŸš€' },
            18: { type: 'bad', value: -8, icon: 'â˜ï¸' },
            28: { type: 'good', value: 12, icon: 'ðŸš€' },
            42: { type: 'bad', value: -10, icon: 'â˜ï¸' },
            55: { type: 'good', value: 15, icon: 'ðŸš€' },
        };

        function createNumberblock(num) {
            const nbContainer = document.createElement('div');
            nbContainer.classList.add('numberblock');
            nbContainer.dataset.number = num;

            const faceContainer = document.createElement('div');
            faceContainer.classList.add('face-container');
            const eye1 = document.createElement('div');
            eye1.classList.add('eye');
            faceContainer.appendChild(eye1);
            if (num > 1) {
                const eye2 = document.createElement('div');
                eye2.classList.add('eye');
                faceContainer.appendChild(eye2);
            }
            
            const stack = document.createElement('div');
            stack.style.display = 'flex';
            stack.style.flexDirection = 'column-reverse';

            for (let i = 0; i < num; i++) {
                const block = document.createElement('div');
                block.classList.add('block', `c${num}`);
                if (i === num - 1) {
                    block.appendChild(faceContainer);
                    nbContainer.classList.add('has-face');
                }
                stack.appendChild(block);
            }
            nbContainer.appendChild(stack);
            return nbContainer;
        }

        function setupCharacterSelection() {
            [1, 2, 3, 4, 5].forEach(num => {
                const char = createNumberblock(num);
                char.addEventListener('click', () => {
                    document.querySelectorAll('#character-selection .numberblock').forEach(nb => nb.classList.remove('selected'));
                    char.classList.add('selected');
                    startGame(num);
                });
                charSelection.appendChild(char);
            });
        }

        function createBoard() {
            svg.innerHTML = ''; // Clear previous board
            pathCoordinates = [];
            
            const width = boardContainer.clientWidth;
            const height = boardContainer.clientHeight;
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            let pathData = `M ${width * 0.1},${height * 0.9}`;
            const rows = 5;
            for (let i = 0; i < rows; i++) {
                const y = height * (0.9 - (i * 0.18));
                const x1 = width * (i % 2 === 0 ? 0.9 : 0.1);
                const x_mid = width * 0.5;
                const y_mid = y + (height * 0.09 * (i % 2 === 0 ? -1 : 1));
                pathData += ` Q ${x_mid},${y_mid} ${x1},${y}`;
            }

            const pathLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathLine.setAttribute('d', pathData);
            pathLine.classList.add('path-line');
            svg.appendChild(pathLine);

            const pathFill = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathFill.setAttribute('d', pathData);
            pathFill.classList.add('path-fill');
            svg.appendChild(pathFill);

            path = pathFill; // Use this for length calculations

            for (let i = 0; i <= TOTAL_STEPS; i++) {
                const point = path.getPointAtLength(i / TOTAL_STEPS * path.getTotalLength());
                pathCoordinates.push(point);

                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', 8);
                circle.classList.add('step-circle');
                svg.appendChild(circle);

                if (specialSteps[i]) {
                    circle.classList.add(`step-special-${specialSteps[i].type}`);
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute('x', point.x);
                    text.setAttribute('y', point.y);
                    text.classList.add('step-text');
                    text.textContent = specialSteps[i].icon;
                    svg.appendChild(text);
                }
            }
        }
        
        function updatePlayerPosition() {
            if (playerPosition > TOTAL_STEPS) playerPosition = TOTAL_STEPS;
            if (playerPosition < 0) playerPosition = 0;
            
            const point = pathCoordinates[playerPosition];
            if(point) {
                const playerHeight = player.offsetHeight;
                player.style.left = `${point.x}px`;
                player.style.top = `${point.y}px`;
            }
        }

        function generateOperation() {
            const operators = ['+', '-', 'Ã—', 'Ã·'];
            let op = operators[Math.floor(Math.random() * operators.length)];
            let num1, num2;

            switch(op) {
                case '+': num1 = Math.ceil(Math.random()*20)+5; num2 = Math.ceil(Math.random()*20)+5; correctAnswer = num1 + num2; break;
                case '-': num1 = Math.ceil(Math.random()*20)+15; num2 = Math.ceil(Math.random()*(num1-5)); correctAnswer = num1 - num2; break;
                case 'Ã—': num1 = Math.ceil(Math.random()*10)+2; num2 = Math.ceil(Math.random()*8)+2; correctAnswer = num1 * num2; break;
                case 'Ã·': num2 = Math.ceil(Math.random()*8)+2; correctAnswer = Math.ceil(Math.random()*8)+2; num1 = num2 * correctAnswer; break;
            }
            opDisplay.textContent = `${num1} ${op} ${num2}`;
        }

        async function movePlayer(steps) {
            submitButton.disabled = true;
            const direction = steps > 0 ? 1 : -1;
            
            for (let i = 0; i < Math.abs(steps); i++) {
                playerPosition += direction;
                if (playerPosition >= TOTAL_STEPS) { playerPosition = TOTAL_STEPS; updatePlayerPosition(); break; }
                if (playerPosition < 0) playerPosition = 0;
                updatePlayerPosition();
                await new Promise(res => setTimeout(res, 50));
            }
            
            if (specialSteps[playerPosition]) {
                const special = specialSteps[playerPosition];
                storyText.textContent = special.type === 'good' ? 'Â¡Genial, un cohete! Â¡Impulso extra!' : 'Â¡Oh no, una nube! Â¡Resbalaste!';
                await new Promise(res => setTimeout(res, 1200));
                await movePlayer(special.value);
                return; 
            }
            
            if (playerPosition >= TOTAL_STEPS) {
                storyText.textContent = `Â¡Felicidades, JesÃºs! Â¡Llegaste a la cima de la montaÃ±a!`;
                opMachine.classList.add('hidden');
            } else {
                storyText.textContent = 'Â¡Tu turno! Resuelve la operaciÃ³n para avanzar.';
                generateOperation();
                submitButton.disabled = false;
            }
        }

        submitButton.addEventListener('click', () => {
            const userAnswer = parseInt(answerInput.value);
            if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                messageArea.textContent = 'Â¡Correcto!';
                messageArea.style.color = '#2ecc71';
                answerInput.value = '';
                movePlayer(Math.min(userAnswer, 25)); 
            } else {
                messageArea.textContent = 'Â¡IntÃ©ntalo de nuevo!';
                messageArea.style.color = '#e74c3c';
            }
        });
        
        function startGame(charNum) {
            player.innerHTML = '';
            player.appendChild(createNumberblock(charNum));
            charSelection.classList.add('hidden');
            opMachine.classList.remove('hidden');
            
            playerPosition = 0;
            updatePlayerPosition();
            generateOperation();
        }

        function initGame() {
            createBoard();
            setupCharacterSelection();
        }

        // Use a robust way to initialize the game
        if (document.readyState === 'complete') {
            initGame();
        } else {
            window.addEventListener('load', initGame);
        }
        
        window.addEventListener('resize', initGame);
    });
    </script>
</body>
</html>
